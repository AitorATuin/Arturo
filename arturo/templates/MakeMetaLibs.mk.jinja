#  _____     _               
# |  _  |___| |_ _ _ ___ ___ 
# |     |  _|  _| | |  _| . |
# |__|__|_| |_| |___|_| |___|
# http://32bits.io/Arturo/
#

-include $(DIR_BUILD)/{{templates.make_toolchain}}

# +----------------------------------------------------------------------------+
# | COMMON VARIABLES
# +----------------------------------------------------------------------------+
OBJ_DIR                 := obj
SOURCE_LIB_NAMES        := $(shell {{commands.source_libs}})
SOURCE_LIB_INCLUDES     := $(addsuffix /{{templates.make_lib}}, $(addprefix $(DIR_BUILD)/$(TARGET_PACKAGE)/$(TARGET_PLATFORM)/$(BOARD)/, $(SOURCE_LIB_NAMES)))

# +----------------------------------------------------------------------------+
# | ACCUMULATORS
# +----------------------------------------------------------------------------+
OBJ_FILES               := 
CPP_HEADERS             :=
C_HEADERS               :=
SOURCE_LIBS             :=

# +----------------------------------------------------------------------------+
# | MAKEFILE INCLUDE AS COMMAND
# +----------------------------------------------------------------------------+
MAKE_STATIC_LIB         := $(DIR_BUILD)/{{templates.make_staticlib}}
MAKE_BIN                := $(DIR_BUILD)/{{templates.make_bin}}
MAKE_CLEAR_VARS         := $(DIR_BUILD)/{{templates.make_clearvars}}

# +----------------------------------------------------------------------------+
# | MAKEFILE GENERATION RULES
# +----------------------------------------------------------------------------+
$(SOURCE_LIB_INCLUDES) : $(DIR_MAKEFILE)/{{this.filename}}
	{{commands.makegen}} {{arguments.islibrary}} {{arguments.path}} $@ {{arguments.template}} "make_lib"

$(DIR_BUILD)/{{templates.make_toolchain}} : $(DIR_MAKEFILE)/{{this.filename}}
	{{commands.makegen}} {{arguments.path}} $@ {{arguments.template}} "make_toolchain"

$(MAKE_STATIC_LIB) : $(DIR_MAKEFILE)/{{this.filename}}
	{{commands.makegen}} {{arguments.path}} $@ {{arguments.template}} "make_staticlib"

$(MAKE_BIN): $(DIR_MAKEFILE)/{{this.filename}}
	{{commands.makegen}} {{arguments.path}} $@ {{arguments.template}} "make_bin"

$(MAKE_CLEAR_VARS): $(DIR_MAKEFILE)/{{this.filename}}
	{{commands.makegen_noexpand}} {{arguments.path}} $@ {{arguments.template}} "make_clearvars"

# +----------------------------------------------------------------------------+
# | LIBRARY MODULES
# +----------------------------------------------------------------------------+
-include $(MAKE_CLEAR_VARS)

define includeLibraryRulesFor
    -include $(1)
endef

$(foreach SOURCE_LIB_INCLUDE,$(SOURCE_LIB_INCLUDES),$(eval $(call includeLibraryRulesFor, $(SOURCE_LIB_INCLUDE))))

# +----------------------------------------------------------------------------+
# | BUILD TARGETS
# +----------------------------------------------------------------------------+
.PHONY : objs
objs : $(OBJ_FILES)
	# Build all the objects

.PHONY : libs
libs : $(SOURCE_LIBS)
	# Build all the libs
