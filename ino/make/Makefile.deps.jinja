
{% set src_build_dir = e.build_dir|pjoin(src_dir|basename) %}

{#
 #   *.c *.cpp -> *.d
 #}
{% set cpp = (src_dir|glob('*.c', '*.cpp') + src_build_dir|glob('*.cpp'))|filemap(src_build_dir, e.names.deps) %}
{% for source, target in cpp %}
{% if source.path.startswith(src_build_dir) %}
    {% set extra_flags = '-iquote ' ~ src_dir|pjoin(source.path|relative_to(src_build_dir))|dirname %}
{% else %}
    {% set extra_flags = '' %}
{% endif %}
{{ target.path }} : {{ source.path }}
	{{v}}{{ e.cc }} {{ e.cflags }} {{ inc_flags }} {{ extra_flags }} -MM $^ > $@;
{% endfor %}

{#
 #   *.d -> united output
 #}
{{ output_filepath }} : {{ cpp.target_paths() }}
	@echo {{ ('Scanning dependencies of ' ~ src_dir|basename)|colorize('cyan') }}
	@mkdir -p {{ output_filepath|dirname }}
	{{v}}cat $^ > $@;

all : {{ output_filepath }}

{#
vim:noexpandtab filetype=jinja
#}
